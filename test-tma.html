<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TMA Tracker SDK Test</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
    }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      font-size: 14px;
    }
    .status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .status.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    button {
      background: #0088cc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #006699;
    }
    .utm-selector {
      margin: 20px 0;
    }
    select {
      padding: 8px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-left: 10px;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ TMA Tracker SDK Test</h1>

    <div id="status" class="status info">
      –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è SDK...
    </div>

    <div class="utm-selector">
      <label>
        <strong>–û–±—Ä–∞—Ç–∏ UTM –∫–∞–º–ø–∞–Ω—ñ—é:</strong>
        <select id="utmSelect">
          <option value="campaign_1">campaign_1</option>
          <option value="campaign_2">campaign_2</option>
          <option value="campaign_3">campaign_3</option>
          <option value="test_campaign">test_campaign</option>
        </select>
      </label>
      <button onclick="initWithSelectedUTM()">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∑ UTM</button>
    </div>

    <div>
      <h3>–î—ñ—ó:</h3>
      <button onclick="trackTestPayment()">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç–µ—Å—Ç–æ–≤–∏–π –ø–ª–∞—Ç—ñ–∂ (100 Stars)</button>
      <button onclick="getUtmInfo()">–û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π UTM</button>
      <button onclick="sendCustomEvent()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∫–∞—Å—Ç–æ–º–Ω—É –ø–æ–¥—ñ—é</button>
    </div>

    <div id="details" style="margin-top: 20px;"></div>
  </div>

  <script type="module">
    // –Ü–º–ø–æ—Ä—Ç—É—î–º–æ SDK
    import TMATracks from './packages/client/dist/index.esm.js';

    // –†–æ–±–∏–º–æ –¥–æ—Å—Ç—É–ø–Ω–∏–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –∫–Ω–æ–ø–æ–∫
    window.TMATracks = TMATracks;
    window.sdkInitialized = false;

    // –°–∏–º—É–ª—è—Ü—ñ—è Telegram WebApp InitData –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
    function mockTelegramWebApp(utmParam) {
      if (!window.Telegram) {
        window.Telegram = {};
      }

      window.Telegram.WebApp = {
        initData: '',
        initDataUnsafe: {
          user: {
            id: 123456789,
            first_name: 'Test',
            last_name: 'User',
            username: 'testuser',
            language_code: 'uk'
          },
          start_param: utmParam || 'campaign_1'
        },
        ready: function() {},
        expand: function() {},
        close: function() {}
      };
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status ${type}`;
      statusDiv.innerHTML = message;
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π
    function showDetails(title, data) {
      const detailsDiv = document.getElementById('details');
      detailsDiv.innerHTML = `
        <h3>${title}</h3>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `;
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∫–Ω–æ–ø–æ–∫
    window.initWithSelectedUTM = async function() {
      const selectedUTM = document.getElementById('utmSelect').value;

      try {
        showStatus('‚è≥ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è SDK –∑ UTM: ' + selectedUTM, 'info');

        // –ú–æ–∫–∞—î–º–æ Telegram WebApp –∑ –æ–±—Ä–∞–Ω–∏–º UTM
        mockTelegramWebApp(selectedUTM);

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è SDK
        await TMATracks.init({
          apiKey: '073dc2bd3f34f2ecda8d76c7f1a354243e9f601e5c951203555f5fb08ae89f5a',
          apiEndpoint: 'http://localhost:3000',
          debug: true
        });

        window.sdkInitialized = true;

        const currentUTM = TMATracks.getUtmParameter();
        showStatus(`‚úÖ SDK —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ!<br>UTM –ø–∞—Ä–∞–º–µ—Ç—Ä: <strong>${currentUTM}</strong><br>–ü–æ–¥—ñ—è app_open –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä`, 'success');

        showDetails('Telegram User Info', window.Telegram.WebApp.initDataUnsafe.user);

      } catch (error) {
        showStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: ${error.message}`, 'error');
        console.error('Init error:', error);
      }
    };

    window.trackTestPayment = async function() {
      if (!window.sdkInitialized) {
        showStatus('‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–π—Ç–µ SDK!', 'error');
        return;
      }

      try {
        showStatus('‚è≥ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—ñ—ó –ø–ª–∞—Ç–µ–∂—É...', 'info');

        await TMATracks.trackPayment({
          amount: 100,
          paymentId: 'test_payment_' + Date.now()
        });

        showStatus('‚úÖ –ü–ª–∞—Ç—ñ–∂ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–æ! (100 Telegram Stars)', 'success');

      } catch (error) {
        showStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ —Ç—Ä–µ–∫—ñ–Ω–≥—É –ø–ª–∞—Ç–µ–∂—É: ${error.message}`, 'error');
        console.error('Payment tracking error:', error);
      }
    };

    window.getUtmInfo = function() {
      if (!window.sdkInitialized) {
        showStatus('‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–π—Ç–µ SDK!', 'error');
        return;
      }

      const utm = TMATracks.getUtmParameter();
      showStatus(`‚ÑπÔ∏è –ü–æ—Ç–æ—á–Ω–∏–π UTM –ø–∞—Ä–∞–º–µ—Ç—Ä: <strong>${utm || '–Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}</strong>`, 'info');
    };

    window.sendCustomEvent = async function() {
      if (!window.sdkInitialized) {
        showStatus('‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–π—Ç–µ SDK!', 'error');
        return;
      }

      try {
        showStatus('‚è≥ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ—ó –ø–æ–¥—ñ—ó...', 'info');

        // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –≤–ª–∞—Å–Ω—ñ –ø–æ–¥—ñ—ó —á–µ—Ä–µ–∑ –ø—Ä—è–º–∏–π –≤–∏–∫–ª–∏–∫ API
        const response = await fetch('http://localhost:3000/api/v1/events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': '073dc2bd3f34f2ecda8d76c7f1a354243e9f601e5c951203555f5fb08ae89f5a'
          },
          body: JSON.stringify({
            event_type: 'custom_event',
            data: {
              utmParameter: TMATracks.getUtmParameter(),
              telegramUserId: window.Telegram.WebApp.initDataUnsafe.user.id,
              customData: 'test_value'
            }
          })
        });

        if (response.ok) {
          showStatus('‚úÖ –ö–∞—Å—Ç–æ–º–Ω–∞ –ø–æ–¥—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞!', 'success');
        } else {
          throw new Error('Server returned error: ' + response.status);
        }

      } catch (error) {
        showStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–¥—ñ—ó: ${error.message}`, 'error');
        console.error('Custom event error:', error);
      }
    };

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑ campaign_1 –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
    showStatus('‚ÑπÔ∏è –û–±–µ—Ä—ñ—Ç—å UTM –∫–∞–º–ø–∞–Ω—ñ—é —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∑ UTM"', 'info');

  </script>
</body>
</html>
